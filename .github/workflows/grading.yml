name: 파일 입출력 프로그램 채점 (Fruit Info)

on: [push]

jobs:
  grade:
    runs-on: ubuntu-latest
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v3

      - name: 채점 스크립트 실행
        id: grading
        run: |
          GREEN='\033[32m'
          RED='\033[31m'
          NC='\033[0m'

          SCORE=0
          FEEDBACK=""

          normalize_output() {
            tr -d '[:space:]\r\n' < "$1"
          }

          echo "::group::테스트 환경 설정 및 컴파일"

          if gcc main.c -o main 2> compile_error.txt; then
            FEEDBACK="[OK] 컴파일 성공.\n"

            # 기대 출력 파일 생성
            echo "offset: 2"     > expected_output.txt
            echo "name: Melon"  >> expected_output.txt
            echo "color: Green" >> expected_output.txt
            echo "price: 32000" >> expected_output.txt

            # 학생 프로그램 실행 (학생 코드가 fruits.txt 및 fruit_info.txt를 생성해야 함)
            ./main

            echo "::endgroup::"
            echo "::group::결과 파일 존재 여부 확인"

            # 1) fruits.txt 존재 확인
            if [ ! -f "fruits.txt" ]; then
              SCORE=0
              FEEDBACK="${FEEDBACK}${RED}[FAIL]${NC} fruits.txt 파일이 생성되지 않았습니다. (0점)\n"
              echo "::error::채점 실패: 입력 파일(fruits.txt)이 없습니다."

            # 2) fruit_info.txt 존재 확인
            elif [ ! -f "fruit_info.txt" ]; then
              SCORE=0
              FEEDBACK="${FEEDBACK}${RED}[FAIL]${NC} fruit_info.txt 파일이 생성되지 않았습니다. (0점)\n"
              echo "::error::채점 실패: 결과 파일(fruit_info.txt)이 없습니다."

            # 3) 두 파일 모두 있을 때 내용 비교
            else
              echo "::endgroup::"
              echo "::group::fruit_info.txt 내용 비교"

              EXPECTED_NORMALIZED="$(normalize_output expected_output.txt)"
              ACTUAL_NORMALIZED="$(normalize_output fruit_info.txt)"

              echo "기대 출력 (정규화됨): $EXPECTED_NORMALIZED"
              echo "실제 출력 (정규화됨): $ACTUAL_NORMALIZED"

              if [ "$ACTUAL_NORMALIZED" = "$EXPECTED_NORMALIZED" ]; then
                SCORE=100
                FEEDBACK="${FEEDBACK}${GREEN}[PASS]${NC} fruits.txt 생성 및 fruit_info.txt 내용 일치! (100점)\n"
              else
                SCORE=0
                FEEDBACK="${FEEDBACK}${RED}[FAIL]${NC} fruit_info.txt 내용이 기대와 다릅니다. (0점)\n"
                FEEDBACK="${FEEDBACK}  [기대하는 파일 내용]:\n$(cat expected_output.txt)\n"
                FEEDBACK="${FEEDBACK}  [학생 프로그램이 생성한 파일 내용]:\n$(cat fruit_info.txt)\n"
                echo "::error::채점 실패: 생성된 파일 내용 불일치."
              fi
            fi
            echo "::endgroup::"

          else
            SCORE=0
            FEEDBACK="${RED}[FAIL]${NC} 컴파일 실패. 코드를 확인하세요.\n"
            FEEDBACK="${FEEDBACK}  [컴파일 오류 메시지]:\n$(cat compile_error.txt)\n"
            echo "::error::컴파일 실패. 자세한 내용은 로그를 확인하세요."
          fi

          # GitHub Classroom 점수/피드백 출력
          echo "score=$SCORE" >> "$GITHUB_OUTPUT"
          echo "feedback<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$FEEDBACK" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          # 100점이 아니면 workflow를 실패 처리
          if [ "$SCORE" -ne 100 ]; then
            exit 1
          fi
