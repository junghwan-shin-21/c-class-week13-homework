name: 학생 성적 관리 프로그램 채점

on: [push]

jobs:
  grade:
    runs-on: ubuntu-latest
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v3

      - name: 채점 스크립트 실행
        id: grading
        run: |
          # ANSI 색상 코드 정의
          GREEN='\033[32m'
          RED='\033[31m'
          NC='\033[0m'

          SCORE=0
          FEEDBACK=""
          
          # 공백을 제거하고 출력을 비교하기 위한 함수
          normalize_output() {
            tr -d ' \t\n\r' < "$1"
          }
          
          echo "::group::컴파일 및 실행 테스트"
          if gcc main.c -o student_manager; then
            FEEDBACK="[OK] 컴파일 성공.\n"
            
            # 예상 출력 파일 생성 (평균: 87.3, High 92, Low 75)
            printf "Average: 87.3\n" > expected_output_core.txt
            printf "High: Bob-92점\n" >> expected_output_core.txt
            printf "Low: Charlie-75점\n" >> expected_output_core.txt

            # 실행 및 출력 캡처
            INPUT_DATA="5\n101\nAlice\n88.5\n102\nBob\n92.0\n103\nCharlie\n75.3\n104\nDavid\n92.0\n105\nEve\n88.5\n"
            
            echo -e "$INPUT_DATA" | ./student_manager > raw_output.txt

            # 핵심 출력 추출 (Average, High, Low 라인만)
            grep -E 'Average:|High:|Low:' raw_output.txt > actual_output.txt
            
            echo "::endgroup::"
            echo "::group::출력 비교 (공백 무시)"
            if [[ "$(normalize_output actual_output.txt)" == "$(normalize_output expected_output_core.txt)" ]]; then
              SCORE=100
              FEEDBACK="${FEEDBACK}${GREEN}[PASS]${NC} 모든 테스트 케이스 통과! (100점)\n"
            else
              SCORE=0
              FEEDBACK="${FEEDBACK}${RED}[FAIL]${NC} 출력 형식이 일치하지 않습니다. (0점)\n"
              FEEDBACK="${FEEDBACK}  [기대하는 핵심 출력 (정규화 전)]:\n$(cat expected_output_core.txt)\n"
              FEEDBACK="${FEEDBACK}  [학생/테스트 출력 (정규화 전)]:\n$(cat actual_output.txt)\n"
              echo "::error::채점 실패: 출력 내용 불일치."
            fi
            echo "::endgroup::"

          else
            SCORE=0
            FEEDBACK="${RED}[FAIL]${NC} 컴파일 실패. 코드를 확인하세요."
            echo "::error::컴파일 실패."
          fi

          # GitHub Classroom 최종 점수 및 피드백 전달
          echo "score=$SCORE" >> "$GITHUB_OUTPUT"
          echo "feedback<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$FEEDBACK" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          
          if [ "$SCORE" -ne 100 ]; then
             exit 1
          fi