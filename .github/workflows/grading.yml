name: C언어 과제 자동 채점

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  grade:
    runs-on: ubuntu-latest

    steps:
      - name: 저장소 체크아웃
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 1. 파일 생성: 테스트 데이터 및 기대 출력 파일 생성
      # -----------------------------------------------------------
      - name: 테스트 파일 생성 (fruits.txt, expected_output.txt)
        id: create_files
        run: |
          # 1. fruits.txt: 학생 코드가 읽어야 할 입력 파일 (하드코딩 방지용 데이터 포함)
          echo "Apple 1000 5" > fruits.txt
          echo "Banana 500 10" >> fruits.txt
          # 하드코딩 방지를 위한 주요 테스트 데이터
          echo "Melon 5000 2" >> fruits.txt
          echo "Grapefruit 3500 3" >> fruits.txt
          
          # 2. expected_output.txt: 학생 코드가 생성해야 할 정답 파일
          echo "Fruit Name: Apple, Total Price: 5000" > expected_output.txt
          echo "Fruit Name: Banana, Total Price: 5000" >> expected_output.txt
          echo "Fruit Name: Melon, Total Price: 10000" >> expected_output.txt
          echo "Fruit Name: Grapefruit, Total Price: 10500" >> expected_output.txt
          
          echo "테스트 파일 생성이 완료되었습니다."

      # -----------------------------------------------------------
      # 2. 파일 존재 여부 확인 (교수님 요청사항)
      # -----------------------------------------------------------
      - name: 필수 입력 파일 존재 여부 확인 (fruits.txt)
        run: |
          # 'test -f' 또는 '[ -f ... ]' 명령어는 파일이 일반 파일로 존재하면 0(성공)을 반환합니다.
          if [ -f fruits.txt ]; then
            echo "✅ 필수 입력 파일 (fruits.txt)이 성공적으로 생성되었음을 확인했습니다."
          else
            echo "❌ 오류: fruits.txt 파일이 존재하지 않습니다. 채점 환경 설정에 문제가 있습니다."
            exit 1 # 스크립트를 즉시 종료하여 다음 단계를 건너뜁니다.
          fi

      # -----------------------------------------------------------
      # 3. 컴파일
      # -----------------------------------------------------------
      - name: C 코드 컴파일
        id: compile
        run: |
          # main.c 파일을 컴파일하여 'main' 실행 파일을 생성
          if gcc main.c -o main; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "컴파일 성공"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "::error::컴파일 실패: 학생의 main.c 파일을 실행 파일로 변환할 수 없습니다."
            exit 1 # 컴파일 실패 시 즉시 종료
          fi
          
      # -----------------------------------------------------------
      # 4. 실행
      # -----------------------------------------------------------
      - name: 프로그램 실행
        id: run
        run: |
          # 컴파일된 실행 파일 (./main) 실행
          # 실행 시 fruit_info.txt 파일이 생성되어야 함
          ./main
          
          # 학생 코드가 fruit_info.txt 파일을 생성했는지 확인
          if [ -f fruit_info.txt ]; then
            echo "✅ 학생 프로그램이 출력 파일 (fruit_info.txt)을 생성했습니다."
          else
            echo "::error::학생 프로그램이 필요한 출력 파일 (fruit_info.txt)을 생성하지 못했습니다."
            exit 1
          fi

      # -----------------------------------------------------------
      # 5. 채점 및 결과 비교
      # -----------------------------------------------------------
      - name: 결과 파일 내용 비교 및 채점
        id: compare
        run: |
          # 1. 줄 바꿈 및 공백을 정규화하는 함수 정의 (비교의 정확성 향상)
          normalize() {
            # 공백 여러 개를 하나로, 앞뒤 공백 제거, 모든 문자를 소문자로 변환 (대소문자 무시를 위해)
            tr -s ' ' < "$1" | sed 's/^[[:space:]]*//; s/[[:space:]]*$//' | tr '[:upper:]' '[:lower:]'
          }

          # 2. 정규화된 파일 생성
          normalize "expected_output.txt" > expected_normalized.txt
          normalize "fruit_info.txt" > student_normalized.txt

          echo "::group::결과 파일 내용 비교 (디버깅용)"
          echo "[기대 출력 (정규화됨)]:"
          cat expected_normalized.txt
          echo "----------------------------------------"
          echo "[학생 출력 (정규화됨)]:"
          cat student_normalized.txt
          echo "::endgroup::"

          # 3. 파일 내용 비교
          if cmp -s expected_normalized.txt student_normalized.txt; then
            echo "::notice::✨ 채점 성공: 학생의 출력 결과가 기대하는 결과와 일치합니다."
            echo "score=100" >> $GITHUB_OUTPUT
          else
            echo "::error::❌ 채점 실패: 출력 내용이 일치하지 않습니다. 파일 입출력 로직을 확인하세요."
            echo "score=0" >> $GITHUB_OUTPUT
          fi

      - name: 최종 점수 표시
        if: always()
        run: |
          # 최종 점수를 GitHub Actions의 Summary에 표시
          echo "## 📈 최종 채점 결과: ${{ steps.compare.outputs.score }}점" >> $GITHUB_STEP_SUMMARY